<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Contract Review - Professional Legal Analysis</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --success-color: #27ae60;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
      --light-bg: #f8f9fa;
      --border-color: #dee2e6;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--light-bg);
      color: var(--primary-color);
    }
    
    .header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      padding: 2rem 0;
      margin-bottom: 2rem;
    }
    
    .header h1 {
      font-weight: 300;
      margin-bottom: 0.5rem;
    }
    
    .header .subtitle {
      opacity: 0.9;
      font-size: 1.1rem;
    }
    
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }
    
    .card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
      margin-bottom: 1.5rem;
    }
    
    .card-header {
      background: white;
      border-bottom: 2px solid var(--border-color);
      border-radius: 12px 12px 0 0 !important;
      padding: 1.25rem;
    }
    
    .card-header h5 {
      margin: 0;
      color: var(--primary-color);
      font-weight: 600;
    }
    
    .form-label {
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }
    
    .form-control, .form-select {
      border: 2px solid var(--border-color);
      border-radius: 8px;
      padding: 0.75rem;
      transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
    }
    
    .btn-primary {
      background: var(--secondary-color);
      border: none;
      border-radius: 8px;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      background: #2980b9;
      transform: translateY(-1px);
    }
    
    .btn-outline-primary {
      border: 2px solid var(--secondary-color);
      color: var(--secondary-color);
      border-radius: 8px;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
    }
    
    .chat-container {
      height: 400px;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      background: white;
      overflow-y: auto;
      padding: 1rem;
    }
    
    .message {
      margin-bottom: 1rem;
      padding: 0.75rem;
      border-radius: 12px;
      max-width: 80%;
    }
    
    .message.user {
      background: var(--secondary-color);
      color: white;
      margin-left: auto;
      text-align: right;
    }
    
    .message.assistant {
      background: #ecf0f1;
      color: var(--primary-color);
      margin-right: auto;
    }
    
    .analysis-report {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-top: 1rem;
    }
    
    .risk-score {
      font-size: 2rem;
      font-weight: bold;
      text-align: center;
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 1rem;
    }
    
    .risk-low { background: #d4edda; color: #155724; }
    .risk-medium { background: #fff3cd; color: #856404; }
    .risk-high { background: #f8d7da; color: #721c24; }
    
    .risk-item, .protection-item {
      background: white;
      border-left: 4px solid var(--secondary-color);
      padding: 1rem;
      margin: 0.75rem 0;
      border-radius: 0 8px 8px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .risk-item.high { border-left-color: var(--danger-color); }
    .risk-item.medium { border-left-color: var(--warning-color); }
    .risk-item.low { border-left-color: var(--success-color); }
    
    .legal-disclaimer {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 1rem;
      margin: 1.5rem 0;
      text-align: center;
    }
    
    .legal-disclaimer i {
      color: var(--warning-color);
      margin-right: 0.5rem;
    }
    
    .status-message {
      padding: 0.75rem;
      border-radius: 8px;
      margin: 1rem 0;
      font-weight: 500;
    }
    
    .status-loading {
      background: #d1ecf1;
      color: #0c5460;
    }
    
    .status-success {
      background: #d4edda;
      color: #155724;
    }
    
    .status-error {
      background: #f8d7da;
      color: #721c24;
    }
    
    .section-divider {
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--border-color), transparent);
      margin: 2rem 0;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="main-container">
      <div class="text-center">
        <h1><i class="fas fa-balance-scale me-3"></i>AI Contract Review</h1>
        <p class="subtitle">Professional Legal Document Analysis & Risk Assessment</p>
      </div>
    </div>
  </div>

  <div class="main-container">
    <!-- Legal Disclaimer -->
    <div class="legal-disclaimer">
      <i class="fas fa-exclamation-triangle"></i>
      <strong>Legal Disclaimer:</strong> This is not meant as legal advice. Consult a lawyer for final review.
    </div>

    <div class="row">
      <!-- Left Column: Contract Analysis -->
      <div class="col-lg-8">
        <div class="card">
          <div class="card-header">
            <h5><i class="fas fa-file-contract me-2"></i>Contract Analysis</h5>
          </div>
          <div class="card-body">
            <form id="analyzeForm">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="contractFile" class="form-label">Contract Document</label>
                    <input type="file" class="form-control" id="contractFile" accept=".pdf,.docx" required>
                    <div class="form-text">Upload PDF or Word document</div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                    <input type="email" class="form-control" id="email" placeholder="your@email.com" required>
                    <div class="form-text">Receive results via email</div>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="jurisdiction" class="form-label">Contract Jurisdiction <span class="text-danger">*</span></label>
                    <select class="form-select" id="jurisdiction" required>
                      <option value="">Select Contract Jurisdiction</option>
                      
                      <!-- U.S. Federal & National Options -->
                      <optgroup label="U.S. Federal & National">
                        <option value="US-Federal">United States – Federal</option>
                        <option value="US-Multistate">Multi-State / Nationwide</option>
                      </optgroup>
                      
                      <!-- U.S. States (Alphabetical) -->
                      <optgroup label="U.S. States">
                        <option value="US-AL">Alabama</option>
                        <option value="US-AK">Alaska</option>
                        <option value="US-AZ">Arizona</option>
                        <option value="US-AR">Arkansas</option>
                        <option value="US-CA">California</option>
                        <option value="US-CO">Colorado</option>
                        <option value="US-CT">Connecticut</option>
                        <option value="US-DE">Delaware</option>
                        <option value="US-FL">Florida</option>
                        <option value="US-GA">Georgia</option>
                        <option value="US-HI">Hawaii</option>
                        <option value="US-ID">Idaho</option>
                        <option value="US-IL">Illinois</option>
                        <option value="US-IN">Indiana</option>
                        <option value="US-IA">Iowa</option>
                        <option value="US-KS">Kansas</option>
                        <option value="US-KY">Kentucky</option>
                        <option value="US-LA">Louisiana</option>
                        <option value="US-ME">Maine</option>
                        <option value="US-MD">Maryland</option>
                        <option value="US-MA">Massachusetts</option>
                        <option value="US-MI">Michigan</option>
                        <option value="US-MN">Minnesota</option>
                        <option value="US-MS">Mississippi</option>
                        <option value="US-MO">Missouri</option>
                        <option value="US-MT">Montana</option>
                        <option value="US-NE">Nebraska</option>
                        <option value="US-NV">Nevada</option>
                        <option value="US-NH">New Hampshire</option>
                        <option value="US-NJ">New Jersey</option>
                        <option value="US-NM">New Mexico</option>
                        <option value="US-NY">New York</option>
                        <option value="US-NC">North Carolina</option>
                        <option value="US-ND">North Dakota</option>
                        <option value="US-OH">Ohio</option>
                        <option value="US-OK">Oklahoma</option>
                        <option value="US-OR">Oregon</option>
                        <option value="US-PA">Pennsylvania</option>
                        <option value="US-RI">Rhode Island</option>
                        <option value="US-SC">South Carolina</option>
                        <option value="US-SD">South Dakota</option>
                        <option value="US-TN">Tennessee</option>
                        <option value="US-TX">Texas</option>
                        <option value="US-UT">Utah</option>
                        <option value="US-VT">Vermont</option>
                        <option value="US-VA">Virginia</option>
                        <option value="US-WA">Washington</option>
                        <option value="US-WV">West Virginia</option>
                        <option value="US-WI">Wisconsin</option>
                        <option value="US-WY">Wyoming</option>
                      </optgroup>
                      
                      <!-- International Options -->
                      <optgroup label="International">
                        <option value="CA">Canada</option>
                        <option value="UK">United Kingdom</option>
                        <option value="EU">European Union</option>
                        <option value="AU">Australia</option>
                        <option value="IN">India</option>
                        <option value="Other">Other (Enter Manually)</option>
                      </optgroup>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="contractType" class="form-label">Contract Type <span class="text-danger">*</span></label>
                    <select class="form-select" id="contractType" required>
                      <option value="">Select Contract Type</option>
                      <option value="NDA">Non-Disclosure Agreement</option>
                      <option value="MSA">Master Service Agreement</option>
                      <option value="SaaS">SaaS Terms of Service</option>
                      <option value="Employment">Employment Agreement</option>
                      <option value="Consulting">Consulting Agreement</option>
                      <option value="License">License Agreement</option>
                      <option value="Purchase">Purchase Agreement</option>
                      <option value="Lease">Lease Agreement</option>
                      <option value="Partnership">Partnership Agreement</option>
                      <option value="Vendor">Vendor Agreement</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <!-- Other Contract Type Input (hidden by default) -->
              <div class="row" id="otherContractTypeRow" style="display: none;">
                <div class="col-12">
                  <div class="mb-3">
                    <label for="otherContractType" class="form-label">Enter custom contract type</label>
                    <input type="text" class="form-control" id="otherContractType" 
                           placeholder="Please specify the contract type">
                  </div>
                </div>
              </div>
              
              <!-- Custom Jurisdiction Input (hidden by default) -->
              <div class="row" id="customJurisdictionRow" style="display: none;">
                <div class="col-12">
                  <div class="mb-3">
                    <label for="customJurisdiction" class="form-label">Enter custom jurisdiction</label>
                    <input type="text" class="form-control" id="customJurisdiction" 
                           placeholder="Please specify the jurisdiction">
                  </div>
                </div>
              </div>

              <button type="submit" class="btn btn-primary w-100">
                <i class="fas fa-search me-2"></i>Analyze Contract
              </button>
            </form>

            <div id="analyzeStatus"></div>
            <div id="analysisReport"></div>
          </div>
        </div>
      </div>

      <!-- Right Column: AI Assistant Chat -->
      <div class="col-lg-4">
        <div class="card">
          <div class="card-header">
            <h5><i class="fas fa-robot me-2"></i>Contract Assistant</h5>
          </div>
          <div class="card-body p-0">
            <div class="chat-container" id="chatContainer">
              <div class="message assistant">
                <strong>AI Assistant:</strong> Hello! I'm here to help you with contract analysis. You can ask me questions about contract terms, risks, or legal concepts before, during, or after uploading your document. How can I assist you today?
              </div>
            </div>
            <div class="p-3 border-top">
              <form id="chatForm">
                <div class="input-group">
                  <input type="text" class="form-control" id="userQuestion" 
                         placeholder="Ask about contract terms, risks, or legal concepts..." required>
                  <button class="btn btn-outline-primary" type="submit">
                    <i class="fas fa-paper-plane"></i>
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const analyzeForm = document.getElementById('analyzeForm');
    const contractFile = document.getElementById('contractFile');
    const email = document.getElementById('email');
    const jurisdiction = document.getElementById('jurisdiction');
    const contractType = document.getElementById('contractType');
    const analyzeStatus = document.getElementById('analyzeStatus');
    const analysisReport = document.getElementById('analysisReport');
    
    const chatForm = document.getElementById('chatForm');
    const userQuestion = document.getElementById('userQuestion');
    const chatContainer = document.getElementById('chatContainer');

    // Contract Analysis
    analyzeForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const file = contractFile.files[0];
      if (!file) return;

      // Validate required fields
      if (!email.value.trim()) {
        showStatus('Please enter your email address.', 'error');
        return;
      }
      if (!jurisdiction.value) {
        showStatus('Please select or enter a contract jurisdiction.', 'error');
        return;
      }
      if (jurisdiction.value === 'Other' && !document.getElementById('customJurisdiction').value.trim()) {
        showStatus('Please specify the custom jurisdiction when selecting "Other".', 'error');
        return;
      }
      if (!contractType.value) {
        showStatus('Please select a contract type.', 'error');
        return;
      }
      if (contractType.value === 'Other' && !document.getElementById('otherContractType').value.trim()) {
        showStatus('Please specify the contract type when selecting "Other".', 'error');
        return;
      }

      const formData = new FormData();
      formData.append('file', file);
      formData.append('jurisdiction', jurisdiction.value); // Jurisdiction is now required
      formData.append('contract_type', contractType.value); // Contract type is now required
      formData.append('email', email.value); // Email is now required
      
      // Add custom jurisdiction if specified
      if (jurisdiction.value === 'Other') {
        formData.append('customJurisdiction', document.getElementById('customJurisdiction').value.trim());
      }
      
      // Add other contract type if specified
      if (contractType.value === 'Other') {
        formData.append('customContractType', document.getElementById('otherContractType').value.trim());
      }

      showStatus('Analyzing your contract... This may take a few minutes.', 'loading');
      analysisReport.innerHTML = '';

      try {
        const response = await fetch('/analyze', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.error) {
          showStatus(result.error, 'error');
          return;
        }

        showStatus('Analysis completed successfully!', 'success');
        displayAnalysisReport(result);
        
        // Add analysis completion message to chat
        addChatMessage('assistant', 'Your contract analysis is complete! I can now answer specific questions about your contract. What would you like to know?');
        
      } catch (error) {
        console.error('Analysis error:', error);
        showStatus('Analysis failed. Please try again.', 'error');
      }
    });

    // Chat functionality
    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const question = userQuestion.value.trim();
      if (!question) return;

      addChatMessage('user', question);
      userQuestion.value = '';

      try {
        const formData = new FormData();
        formData.append('query', question);
        if (jurisdiction.value) formData.append('jurisdiction', jurisdiction.value);
        if (contractType.value) formData.append('contract_type', contractType.value);

        // Use streaming chat endpoint
        const response = await fetch('/chat', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        // Create placeholder for streaming response
        const responseDiv = document.createElement('div');
        responseDiv.className = 'message assistant';
        responseDiv.innerHTML = '<strong>AI Assistant:</strong><br><span class=\"streaming-response\"></span>';
        chatContainer.appendChild(responseDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        const streamingSpan = responseDiv.querySelector('.streaming-response');
        let fullResponse = '';

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          
          const chunk = decoder.decode(value, { stream: true });
          const lines = chunk.split('\\n');
          
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.substring(6);
              if (data === '[DONE]') {
                // Apply final formatting to the complete response
                streamingSpan.innerHTML = formatAssistantMessage(fullResponse);
                return;
              }
              fullResponse += data;
              streamingSpan.textContent = fullResponse;
              chatContainer.scrollTop = chatContainer.scrollHeight;
            }
          }
        }
        
      } catch (error) {
        console.error('Chat error:', error);
        addChatMessage('assistant', 'I apologize, but I encountered an error processing your question. Please try again.');
      }
    });

    function showStatus(message, type) {
      analyzeStatus.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
    }

    function addChatMessage(sender, message) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;
      
      if (sender === 'assistant') {
        // Format the assistant message with better structure
        const formattedMessage = formatAssistantMessage(message);
        messageDiv.innerHTML = `<strong>AI Assistant:</strong><br>${formattedMessage}`;
      } else {
        messageDiv.innerHTML = `<strong>You:</strong> ${message}`;
      }
      
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function formatAssistantMessage(message) {
      // Structure the message for better readability
      let formatted = message;
      
      // Add line breaks for better readability
      formatted = formatted.replace(/\n/g, '<br>');
      
      // Format numbered lists (normal weight for numbers, bold for content)
      formatted = formatted.replace(/(\d+\.\s)(.+?)(?=<br>|$)/g, '<br>$1<strong>$2</strong>');
      
      // Format bullet points (normal weight for bullets, bold for content)  
      formatted = formatted.replace(/([•\-\*]\s)(.+?)(?=<br>|$)/g, '<br>&nbsp;&nbsp;$1<strong>$2</strong>');
      
      // Format headers with ### (normal weight for headers)
      formatted = formatted.replace(/###\s(.+?):/g, '<br>$1:');
      
      // Format sections that start with capital letters and colon (normal weight for headers)
      formatted = formatted.replace(/([A-Z][^:]*?):/g, '$1:');
      
      // Format bold text with ** (keep original bold formatting)
      formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      
      // Add spacing between major sections
      formatted = formatted.replace(/<br><strong>(\d+\.)/g, '<br><br><strong>$1');
      
      // Clean up multiple consecutive breaks
      formatted = formatted.replace(/<br><br><br>/g, '<br><br>');
      
      return formatted;
    }

    function displayAnalysisReport(analysis) {
      const riskScore = analysis.risk_score || analysis.overall_risk_score || 0;
      const riskLevel = riskScore >= 7 ? 'high' : riskScore >= 4 ? 'medium' : 'low';
      
      let html = `
        <div class="analysis-report">
          <div class="risk-score risk-${riskLevel}">
            <div>Overall Risk Score</div>
            <div>${riskScore}/10</div>
          </div>
          
          <div class="mb-4">
            <h6><i class="fas fa-clipboard-list me-2"></i>Executive Summary</h6>
            <p class="mb-0">${analysis.summary}</p>
          </div>
      `;

      if (analysis.risky_clauses && analysis.risky_clauses.length > 0) {
        html += `
          <div class="mb-4">
            <h6><i class="fas fa-exclamation-triangle me-2"></i>Risk Analysis (${analysis.risky_clauses.length} items)</h6>
        `;
        
        analysis.risky_clauses.forEach(clause => {
          const level = clause.risk_level ? clause.risk_level.toLowerCase() : 'medium';
          html += `
            <div class="risk-item ${level}">
              <div class="fw-bold">${clause.clause_type}</div>
              <div class="mb-2">${clause.description}</div>
              <div class="text-muted"><i class="fas fa-lightbulb me-1"></i>${clause.recommendation}</div>
            </div>
          `;
        });
        html += '</div>';
      }

      if (analysis.missing_protections && analysis.missing_protections.length > 0) {
        html += `
          <div class="mb-4">
            <h6><i class="fas fa-shield-alt me-2"></i>Missing Protections (${analysis.missing_protections.length} items)</h6>
        `;
        
        analysis.missing_protections.forEach(protection => {
          html += `
            <div class="protection-item">
              <div class="fw-bold">${protection.protection_type}</div>
              <div class="mb-2">${protection.description}</div>
              <div class="text-muted mb-2"><strong>Importance:</strong> ${protection.importance}</div>
              <div class="text-muted"><i class="fas fa-plus-circle me-1"></i><strong>Suggested:</strong> ${protection.suggested_clause}</div>
            </div>
          `;
        });
        html += '</div>';
      }

      if (analysis.detailed_analysis) {
        html += `
          <div class="mb-4">
            <h6><i class="fas fa-search me-2"></i>Detailed Analysis</h6>
            <p class="mb-0">${analysis.detailed_analysis}</p>
          </div>
        `;
      }

      html += '</div>';
      analysisReport.innerHTML = html;
    }
    
    // Handle "Other" contract type selection
    contractType.addEventListener('change', function() {
      const otherRow = document.getElementById('otherContractTypeRow');
      if (this.value === 'Other') {
        otherRow.style.display = 'block';
        document.getElementById('otherContractType').required = true;
      } else {
        otherRow.style.display = 'none';
        document.getElementById('otherContractType').required = false;
        document.getElementById('otherContractType').value = '';
      }
    });
    
    // Handle "Other" jurisdiction selection
    jurisdiction.addEventListener('change', function() {
      const customJurisdictionRow = document.getElementById('customJurisdictionRow');
      if (this.value === 'Other') {
        customJurisdictionRow.style.display = 'block';
        document.getElementById('customJurisdiction').required = true;
      } else {
        customJurisdictionRow.style.display = 'none';
        document.getElementById('customJurisdiction').required = false;
        document.getElementById('customJurisdiction').value = '';
      }
    });

  </script>
</body>
</html>